<!DOCTYPE html>
<html lang="he">

<head>
  <meta charset="UTF-8" />
  <title>לוח זמנים לתפילה</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-white text-gray-900 p-6 font-sans">
  <div class="max-w-2xl mx-auto">
    <h1 class="text-3xl font-bold mb-6" dir="rtl">לוח זמנים לתפילה</h1>

    <div class="flex gap-2 mb-6">
      <input type="time" id="netz" value="05:43:36" step="1"
        class="w-40 px-2 py-1 border border-gray-300 rounded text-left" style="direction: ltr; text-align: left;" />
      <label for="netz" class="text-lg font-medium" dir="rtl">זמן נץ:</label>
    </div>

    <table class="w-full text-right border border-collapse border-gray-300">
      <tbody id="schedule" class="bg-white divide-y divide-gray-200"></tbody>
    </table>
  </div>

  <!-- Hidden video for iOS wake lock -->
  <video id="wakelock-video" muted playsinline loop style="display:none">
    <source src="data:video/mp4;base64,AAAAHGZ0eXBtcDQyAAAAAG1wNDFtcDQyaXNvbTY4" type="video/mp4" />
  </video>

  <script>
    const segments = [
      { label: "תהילות", offset: 30 },
      { label: "אמת", offset: 75 },
      { label: "שמע", offset: 140 },
      { label: "ברכו", offset: 120 },
      { label: "ישתבח", offset: 60 },
      { label: "פסוקי דזמרה", offset: 540 },
      { label: "ברכות", offset: 360 },
    ];

    function generateSchedule() {
      const netzInput = document.getElementById("netz").value;
      if (!netzInput) return;

      const [h, m, s] = netzInput.split(":").map(Number);
      let current = new Date();
      current.setHours(h, m, s || 0, 0);

      const schedule = [{ label: "נץ החמה", time: new Date(current) }];
      for (const segment of segments) {
        current = new Date(current.getTime() - segment.offset * 1000);
        schedule.unshift({ label: segment.label, time: new Date(current) });
      }

      const tbody = document.getElementById("schedule");
      tbody.innerHTML = "";
      schedule.forEach(({ label, time }) => {
        const hours = time.getHours(); // no leading zero
        const minutes = String(time.getMinutes()).padStart(2, "0");
        const seconds = String(time.getSeconds()).padStart(2, "0");
        const timeStr = `${hours}:${minutes}:${seconds}`;
        const row = `<tr><td class="px-3 py-2">${timeStr}</td><td class="px-3 py-2" dir="rtl">${label}</td></tr>`;
        tbody.innerHTML += row;
      });
    }

    // Wake Lock API for Android/modern browsers
    let wakeLock = null;
    async function requestWakeLock() {
      try {
        wakeLock = await navigator.wakeLock.request("screen");
        wakeLock.addEventListener("release", () => {
          console.log("שחרור מסך מתעורר");
        });
        console.log("מסך נשאר פעיל");
      } catch (err) {
        console.warn(`בעיה עם Wake Lock: ${err.name}, ${err.message}`);
      }
    }

    // iOS Safari workaround: silent video
    function startIosWakeLock() {
      const video = document.getElementById("wakelock-video");
      video.play().catch(err => {
        console.warn("הפעלת וידאו נכשלה (ייתכן ונדרש מחוות משתמש):", err);
      });
    }

    window.addEventListener("load", () => {
      generateSchedule();

      document.getElementById("netz").addEventListener("input", generateSchedule);

      if ("wakeLock" in navigator) {
        requestWakeLock();
        document.addEventListener("visibilitychange", () => {
          if (wakeLock !== null && document.visibilityState === "visible") {
            requestWakeLock();
          }
        });
      } else {
        startIosWakeLock();
      }
    });
  </script>
</body>

</html>