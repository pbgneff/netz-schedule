<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>לוח זמנים לתפילה</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      direction: rtl;
      background: #fdfdfd;
    }
    table {
      border-collapse: collapse;
      margin-top: 1rem;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: right;
    }
    input {
      font-size: 1rem;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <h1>לוח זמנים לתפילה</h1>

  <label for="netz">זמן נץ:</label>
  <input type="time" id="netz" value="05:43:36" step="1">

  <table id="schedule">
    <thead>
      <tr><th>שלב</th><th>שעה</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Hidden video for iOS wake lock -->
  <video id="wakelock-video" muted playsinline loop style="display:none">
    <source src="data:video/mp4;base64,AAAAHGZ0eXBtcDQyAAAAAG1wNDFtcDQyaXNvbTY4" type="video/mp4" />
  </video>

  <script>
    const segments = [
      { label: "תהילות", offset: 30 },
      { label: "אמת", offset: 75 },
      { label: "שמע", offset: 140 },
      { label: "ברכו", offset: 120 },
      { label: "ישתבח", offset: 60 },
      { label: "פסוקי דזמרה", offset: 540 },
      { label: "ברכות", offset: 360 },
    ];

    function generateSchedule() {
      const netzInput = document.getElementById("netz").value;
      if (!netzInput) return;

      const [h, m, s] = netzInput.split(":").map(Number);
      let current = new Date();
      current.setHours(h, m, s || 0, 0);

      const schedule = [{ label: "נץ החמה", time: new Date(current) }];
      for (const segment of segments) {
        current = new Date(current.getTime() - segment.offset * 1000);
        schedule.unshift({ label: segment.label, time: new Date(current) });
      }

      const tbody = document.querySelector("#schedule tbody");
      tbody.innerHTML = "";
      schedule.forEach(({ label, time }) => {
        const hours = time.getHours();
        const minutes = String(time.getMinutes()).padStart(2, "0");
        const seconds = String(time.getSeconds()).padStart(2, "0");
        const timeStr = `${hours}:${minutes}:${seconds}`;
        const row = `<tr><td>${label}</td><td>${timeStr}</td></tr>`;
        tbody.innerHTML += row;
      });
    }

    // Wake Lock API for Android/modern browsers
    let wakeLock = null;
    async function requestWakeLock() {
      try {
        wakeLock = await navigator.wakeLock.request("screen");
        wakeLock.addEventListener("release", () => {
          console.log("שחרור מסך מתעורר");
        });
        console.log("מסך נשאר פעיל");
      } catch (err) {
        console.warn(`בעיה עם Wake Lock: ${err.name}, ${err.message}`);
      }
    }

    // iOS Safari workaround: silent video
    function startIosWakeLock() {
      const video = document.getElementById("wakelock-video");
      video.play().catch(err => {
        console.warn("הפעלת וידאו נכשלה (ייתכן ונדרש מחוות משתמש):", err);
      });
    }

    // Setup
    window.addEventListener("load", () => {
      generateSchedule();

      const netzInput = document.getElementById("netz");
      netzInput.addEventListener("input", generateSchedule);

      if ("wakeLock" in navigator) {
        requestWakeLock();
        document.addEventListener("visibilitychange", () => {
          if (wakeLock !== null && document.visibilityState === "visible") {
            requestWakeLock();
          }
        });
      } else {
        startIosWakeLock(); // fallback for iOS
      }
    });
  </script>
</body>
</html>
